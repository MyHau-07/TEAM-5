{% extends "home/master.html" %}

{% block navbar %} 
    {% include 'home/includes/Navbar.html' %}
{% endblock %}

{% block menu-inner %} 
{% include 'home/includes/left_menu.html' %}
{% endblock %}

{% block content %}

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="col-md-12">
        <div class="card">
          <h4 class="card-header text-center fw-bolder">ƒêƒÇNG K√ç D·ªäCH V·ª§ üè•</h4>

          <div class="card-body">
            <form action='{% url 'booking' %}' method='POST' enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="defaultInput" class="form-label">H·ªç v√† t√™n</label>
                    <input id="defaultInput" class="form-control" type="text" placeholder="Nh·∫≠p h·ªç v√† t√™n" name='fullname' required />
                </div>
                <div class="mb-4">
                    <label for="defaultInput" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input id="defaultInput" class="form-control" type="text" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" name='phone' required />
                </div>
                <div class="mb-4">
                    <label for="defaultInput" class="form-label">Email</label>
                    <input id="defaultInput" class="form-control" type="email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" name='email' required />
                </div>

                <div class="mb-4">
                    <label for="defaultSelect" class="form-label">ƒê·ªãa ƒëi·ªÉm</label>
                    <select id="defaultSelect" class="form-select" name='location' required>
                        <option value="">Ch·ªçn ƒë·ªãa ƒëi·ªÉm</option>
                        <option value="02 V√µ Oanh, Ph∆∞·ªùng 25, B√¨nh Th·∫°nh, H·ªì Ch√≠ Minh">02 V√µ Oanh, Ph∆∞·ªùng 25, B√¨nh Th·∫°nh, H·ªì Ch√≠ Minh</option>
                        <option value="S·ªë 70 ƒë∆∞·ªùng T√¥ K√Ω, ph∆∞·ªùng T√¢n Ch√°nh Hi·ªáp, qu·∫≠n 12, TPHCM">S·ªë 70 ƒë∆∞·ªùng T√¥ K√Ω, ph∆∞·ªùng T√¢n Ch√°nh Hi·ªáp, qu·∫≠n 12, TPHCM</option>
                        <option value="10/12 Tr·∫ßn N√£o, KP3, P. B√¨nh An, TP. Th·ªß ƒê·ª©c, TP. HCM">10/12 Tr·∫ßn N√£o, KP3, P. B√¨nh An, TP. Th·ªß ƒê·ª©c, TP. HCM</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="defaultSelect" class="form-label">D·ªãch V·ª•</label>
                    <select id="defaultSelect" class="form-select" name='dich_vu' required>
                        <option value="">Ch·ªçn d·ªãch v·ª•</option>
                        {% for service in serv %}
                            <option value="{{ service.id }}">{{ service.name }}</option> <!-- Use service.id if you need the ID -->
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="defaultInput" class="form-label">Th√¥ng tin b·ªánh (n·∫øu c√≥)</label>
                    <input id="defaultInput" class="form-control" type="text" placeholder="Nh·∫≠p th√¥ng tin b·ªánh (n·∫øu c√≥)" name='message' />
                </div>
                <div class="mb-4">
                    <label for="formFile" class="form-label">T·∫£i ·∫£nh (n·∫øu c√≥)</label>
                    <input class="form-control" type="file" id="formFile" name="photo" />
                </div>
                <div class="mb-4">
                    <label for="id_appointment_date" class="form-label">Ch·ªçn ng√†y h·∫πn</label>
                    <input type="date" id="id_appointment_date" name="appointment_date" class="form-control" value="{{ selected_date }}">
                </div>
                <div class="mb-4">
                    <label for="appointment-time-select" class="form-label">Ch·ªçn gi·ªù h·∫πn</label>
                    <select id="appointment-time-select" class="form-select" name="appointment_time">
                        <option value="">Ch·ªçn gi·ªù h·∫πn</option>
                        {% for time in valid_times %}
                            <option value="{{ time }}">{{ time }}</option>
                        {% endfor %}
                    </select>
                    <div id="availability-message" style="color: red;"></div> <!-- Th√¥ng b√°o v·ªÅ t√¨nh tr·∫°ng gi·ªù h·∫πn -->
                </div>
            
                <div class="col-md-12 text-center mb-5">
                    <button id="complete-btn" type="submit" class="btn btn-primary btn-lg">
                        Ho√†n t·∫•t
                    </button>
                </div>
            </form>

        </div> <!-- End of card body -->
      </div> <!-- End of card -->
    </div> <!-- End of col-md-12 -->
</div> <!-- End of container -->

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('appointment-date');
        const timeInput = document.getElementById('appointment-time-select');
        const timeSelectionDiv = document.getElementById('time-selection');
        const messageDiv = document.getElementById('availability-message');
    
        dateInput.addEventListener('change', function() {
            if (this.value) {
                timeSelectionDiv.style.display = 'block';
    
                // L·∫•y lo·∫°i d·ªãch v·ª• ƒë√£ ch·ªçn
                const selectedServiceType = document.querySelector('input[name="service_type"]:checked').value;
    
                // G·ªçi get_valid_times v·ªõi c·∫£ ng√†y v√† lo·∫°i d·ªãch v·ª•
                fetch(`/get-valid-times?date=${this.value}&service_type=${selectedServiceType}`)
                .then(response => response.json())
                .then(data => {
                    const timeSelect = document.getElementById('appointment-time-select');
                    timeSelect.innerHTML = '<option value="">Ch·ªçn gi·ªù h·∫πn</option>';
    
                    data.valid_times.forEach(time => {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        timeSelect.appendChild(option);
                    });
    
                    // X√≥a th√¥ng b√°o c≈© (n·∫øu c√≥)
                    messageDiv.textContent = '';
                });
            } else {
                timeSelectionDiv.style.display = 'none';
            }
        });
    });
    document.getElementById('id_appointment_date').addEventListener('change', function() {
        const selectedDate = this.value; // L·∫•y gi√° tr·ªã ng√†y ƒë∆∞·ª£c ch·ªçn

        // G·ª≠i y√™u c·∫ßu AJAX ƒë·∫øn server
        fetch(`/get_valid_times/?appointment_date=${selectedDate}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // ƒê√°nh d·∫•u y√™u c·∫ßu l√† AJAX
            }
        })
        .then(response => response.json()) // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
        .then(data => {
            const timeSelect = document.getElementById('id_appointment_time');
            timeSelect.innerHTML = ''; // X√≥a c√°c option c≈©

            // Th√™m c√°c option m·ªõi t·ª´ d·ªØ li·ªáu tr·∫£ v·ªÅ
            data.valid_times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i th·ªùi gian h·ª£p l·ªá:', error);
        });
    });
</script>
{% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                Swal.fire({
                    title: 'Th√¥ng b√°o',
                    text: '{{ message }}',
                    icon: '{% if message.tags == "success" %}success{% else %}error{% endif %}',
                    confirmButtonText: 'OK'
                });
            {% endfor %}
        });

    </script>
{% endif %}

{% endblock %}


{% block footer %} 
{% include "home/includes/footer.html" %}
{% endblock %}